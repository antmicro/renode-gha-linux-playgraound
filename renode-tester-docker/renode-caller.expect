#!/usr/bin/expect

set timeout 60
log_user 0
set cmd [lindex $argv 0]

spawn telnet 127.0.0.1 1234
expect {
    "'^]'." {
        sleep 5
    } timeout {
        send_user "Timeout!"
        exit 1
    }
}

log_user 1
set timeout -1
send "$cmd\n"
expect "#"

log_user 0
set timeout 10
send "echo $?\n"
expect -indices -re "(\\d+)"
exit $expect_out(1,string)
